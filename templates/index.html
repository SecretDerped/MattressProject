<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/suggestions-jquery@22.6.0/dist/css/suggestions.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        :root {
            --placeholder-color: #adb5bd;
        }

        body {
            font-family: 'Source Sans Pro', sans-serif;
        }

        .form-column {
            display: inline-block;
            vertical-align: top;
            width: 100%;
            padding: 0 10px;
            margin-bottom: 0.1rem;
        }

        .form-control {
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 0.1rem;
        }

        .form-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 0.1rem;
        }

        .positions-separator {
            margin-bottom: 2.5rem;
        }

        .positions-separator::after {
            content: '';
            display: block;
            margin-top: 1rem;
            border-bottom: 2px solid #6c757d;
            border-radius: 5px;
        }

        .form-group + .form-group {
            margin-top: 10px;
        }

        .delivery-type-group {
            margin-left: 10px;
            margin-top: 10px;
        }

        .btn-sm {
            width: 25px;
            height: 25px;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .custom-file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            width: 100%;
            height: 44px;
            opacity: 0;
            position: absolute;
            left: 0;
            top: 0;
            cursor: pointer;
        }

        .custom-file-input-button {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            color: #ffffff;
            background-color: #007bff;
            border-radius: 10px;
            cursor: pointer;
            width: calc(100% - 20px);
            text-align: center;
            border: none;
        }

        .custom-file-input-button:hover {
            background-color: #0056b3;
        }

        button[type="submit"] {
            display: block;
            margin: 0 auto;
            width: 75%;
            margin-top: 20px;
            border-radius: 10px;
        }

        h1 {
            text-align: center;
            margin-top: 1rem;
        }

        @media (min-width: 768px) {
            .form-column {
                width: 49%;
            }
        }
    </style>
</head>

<body>
    <h1 class="mb-4 font-weight-bold">üìú –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</h1>
    <div class="container mt-3">
        <form method="POST">
            <!-- –ü–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ —Ñ–æ—Ä–º—ã -->
            <div class="form-column">
                <!-- –ü–æ–∑–∏—Ü–∏–∏ -->
                <div class="form-group">
                    <label for="positionsTable" class="form-label"> </label>
                    <table class="table" id="positionsTable">
                        <thead>
                            <tr>
                                <th>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- –°—Ç—Ä–æ–∫–∏ —Å –ø–æ–∑–∏—Ü–∏—è–º–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                        </tbody>
                    </table>
                    <input type="text" id="newArticle" name="newArticle" class="form-control" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é...">
                    <input type="hidden" id="positionsData" name="positionsData" value="" required>
                </div>
                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                <div class="form-group">
                    <label for="comment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–æ –≤—Å–µ–º—É –∑–∞–∫–∞–∑—É</label>
                    <textarea id="comment" name="comment" class="form-control" style="height: 152px;"></textarea>
                </div>
                <!-- –ö–æ–º–ø–∞–Ω–∏—è -->
                <div class="form-group">
                    <label for="party" class="form-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
                    <input type="text" id="party" name="party" class="form-control">
                    <input type="hidden" id="party_data" name="party_data" class="form-control" value="">
                </div>
                <!-- –§–æ—Ç–æ -->
                <div class="form-group">
                    <label for="photo" class="form-label">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ (PNG, JPEG, JPG ‚Ä¢ –ù–µ –±–æ–ª—å—à–µ 20 –ú–±)</label>
                    <div class="custom-file-input-wrapper">
                        <input type="file" id="photo" name="photo" class="file-input" accept=".jpg, .jpeg, .png">
                        <button type="button" class="custom-file-input-button">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª | –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ ‚òÅÔ∏è</button>
                    </div>
                    <div id="file-error" class="text-danger mt-2" style="display: none;">–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º (JPEG, PNG) –∏ –≤–µ—Å–∏—Ç—å –Ω–µ –±–æ–ª–µ–µ 20 –ú–±.</div>
                    <input type="hidden" id="photo_data" name="photo_data">
                </div>
            </div>

            <!-- –í—Ç–æ—Ä–∞—è –∫–æ–ª–æ–Ω–∫–∞ —Ñ–æ—Ä–º—ã -->
            <div class="form-column">
                <!-- –ü–µ—Ä–≤–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞ —Ñ–æ—Ä–º—ã -->
                <div class="form-column">
                    <!-- –°—Ä–æ–∫ -->
                    <div class="form-group">
                        <label for="delivery_date" class="form-label">–°—Ä–æ–∫ –¥–æ:</label>
                        <input type="date" id="delivery_date" name="delivery_date" class="form-control">
                    </div>
                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç -->
                    <div class="form-group">
                        <label for="contact" class="form-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</label>
                        <input type="text" id="contact" name="contact" class="form-control">
                    </div>
                </div>
                <!-- –í—Ç–æ—Ä–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞ —Ñ–æ—Ä–º—ã -->
                <div class="form-column">
                    <!-- –¶–µ–Ω–∞ -->
                    <div class="form-group">
                        <label for="price" class="form-label">–¶–µ–Ω–∞</label>
                        <input type="number" id="price" name="price" class="form-control" step="0.01">
                    </div>
                    <!-- –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ -->
                    <div class="form-group">
                        <label for="prepayment" class="form-label">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</label>
                        <input type="number" id="prepayment" name="prepayment" class="form-control" step="0.01">
                    </div>
                </div>

                <!-- –¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –∞–¥—Ä–µ—Å -->
                <div class="form-group delivery-type-group">
                    <label class="form-label">–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                    <div>
                        <input type="radio" id="pickup" name="delivery_type" value="–°–∞–º–æ–≤—ã–≤–æ–∑" checked>
                        <label for="pickup"> üìç –°–∞–º–æ–≤—ã–≤–æ–∑</label>
                    </div>
                    <div>
                        <input type="radio" id="city" name="delivery_type" value="–ì–æ—Ä–æ–¥">
                        <label for="city"> üè° –ì–æ—Ä–æ–¥</label>
                    </div>
                    <div>
                        <input type="radio" id="territory" name="delivery_type" value="–ö—Ä–∞–π">
                        <label for="territory"> üó∫Ô∏è –ö—Ä–∞–π</label>
                    </div>
                    <div>
                        <input type="radio" id="region" name="delivery_type" value="–†–µ–≥–∏–æ–Ω">
                        <label for="region"> üåé –†–µ–≥–∏–æ–Ω—ã</label>
                    </div>
                    <!-- –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                    <div class="form-group" id="address-group" style="display:none;">
                        <label for="delivery_address" class="form-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <input type="text" id="delivery_address" name="delivery_address" class="form-control">
                        <input type="hidden" id="address_data" name="address_data" class="form-control" value="">
                    </div>
                    <!-- –í—ã–±–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                    <div class="form-group" id="region-group" style="display:none;">
                    <label for="region_select" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</label>
                    <select id="region_select" name="region_select" class="form-control">
                        <option value="–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å">–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                        <option value="–°–µ–≤–µ—Ä–Ω—ã–π –ö–∞–≤–∫–∞–∑">–°–µ–≤–µ—Ä–Ω—ã–π –ö–∞–≤–∫–∞–∑</option>
                        <option value="–£—Ä–∞–ª—å—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥">–£—Ä–∞–ª—å—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥</option>
                    </select>
                </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã -->
            <div class="form-group">
                <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/suggestions-jquery@22.6.0/dist/js/jquery.suggestions.min.js"></script>
    <script>
        document.querySelector('.file-input').addEventListener('change', function(event) {
            var file = event.target.files[0];
            var fileName = file ? file.name : 'üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª | –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ ‚òÅÔ∏è';
            var fileError = document.getElementById('file-error');
            fileError.style.display = 'none';

            if (file && file.size <= 20 * 1024 * 1024 && (file.type === 'image/jpeg' || file.type === 'image/png')) {
                document.querySelector('.custom-file-input-button').textContent = fileName;
                document.querySelector('.custom-file-input-button').classList.remove('btn-danger');
                document.querySelector('.custom-file-input-button').classList.add('btn-primary');
            } else {
                document.querySelector('.custom-file-input-button').textContent = 'üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª | –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ ‚òÅÔ∏è';
                fileError.style.display = 'block';
                document.querySelector('.custom-file-input-button').classList.add('btn-danger');
                document.querySelector('.custom-file-input-button').classList.remove('btn-primary');
                event.target.value = ''; // —Å–±—Ä–æ—Å–∏—Ç—å input
            }
        });

        $("#party").suggestions({
            token: "4eaa705b0abe5c4a4d7f1e28ff2575c61532a8da",
            type: "PARTY",
            onSelect: function (suggestion) {
                console.log(suggestion);
                $('#party_data').val(JSON.stringify(suggestion));
            }
        });

        $("#delivery_address").suggestions({
            token: "4eaa705b0abe5c4a4d7f1e28ff2575c61532a8da",
            type: "ADDRESS",
            onSelect: function (suggestion) {
                console.log(suggestion);
                $('#address_data').val(JSON.stringify(suggestion));
            }
        });

        $('input[name="delivery_type"]').change(function () {
            var selectedType = $('input[name="delivery_type"]:checked').val();
            if (selectedType === '–°–∞–º–æ–≤—ã–≤–æ–∑') {
                $('#address-group').hide();
                $('#region-group').hide();
            } else if (selectedType === '–ì–æ—Ä–æ–¥' || selectedType === '–ö—Ä–∞–π') {
                $('#address-group').show();
                $('#region-group').hide();
            } else if (selectedType === '–†–µ–≥–∏–æ–Ω') {
                $('#address-group').show();
                $('#region-group').show();
            }
        });

        $("#photo").change(function () {
            var file = this.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#photo_data').val(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        $(document).ready(function () {
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var yyyy = today.getFullYear();
            var formattedDate = yyyy + '-' + mm + '-' + dd;
            $('#delivery_date').val(formattedDate);
        });
    </script>
    <script>
        $(document).ready(function () {
            var positions = [];

            $('#positionsTable').hide();

            function updatePositionsInput() {
                $('#positionsData').val(JSON.stringify(positions));
            }

            function addPosition(article, quantity) {
                var existingPosition = positions.find(position => position.article === article);
                if (existingPosition) {
                    existingPosition.quantity += quantity;
                } else {
                    positions.push({ article: article, quantity: quantity });
                }
                updatePositionsTable();
                updatePositionsInput();
            }

            function updatePositionsTable() {
                var tableBody = $('#positionsTable tbody');
                tableBody.empty();
                positions.forEach(function (position, index) {
                    var row = $('<tr></tr>');
                    row.append($('<td></td>').text(position.article));

                    var quantityCell = $('<td class="quantity-col"></td>');
                    var minusButton = $('<button type="button" class="btn btn-secondary btn-sm mx-1">-</button>').click(function () {
                        var quantity = parseInt(quantityInput.text(), 10);
                        if (quantity > 1) {
                            quantityInput.text(quantity - 1);
                            positions[index].quantity = quantity - 1;
                            updatePositionsInput();
                        } else {
                            positions.splice(index, 1);
                            updatePositionsTable();
                            updatePositionsInput();
                        }
                    });
                    var quantityInput = $('<span class="quantity">' + position.quantity + '</span>').on('input', function () {
                        var value = parseInt($(this).text(), 10);
                        if (value >= 1 && value <= 999) {
                            positions[index].quantity = value;
                            updatePositionsInput();
                        }
                    });
                    var plusButton = $('<button type="button" class="btn btn-secondary btn-sm mx-1">+</button>').click(function () {
                        var quantity = parseInt(quantityInput.text(), 10);
                        if (quantity < 999) {
                            quantityInput.text(quantity + 1);
                            positions[index].quantity = quantity + 1;
                            updatePositionsInput();
                        }
                    });
                    quantityCell.append(minusButton, quantityInput, plusButton);
                    row.append(quantityCell);

                    tableBody.append(row);
                });

                if (positions.length > 0) {
                    $('#positionsTable').show();
                } else {
                    $('#positionsTable').hide();
                }
            }

            $('#newArticle').autocomplete({
                source: function (request, response) {
                    $.getJSON('/api/articles', function (data) {
                        var results = $.ui.autocomplete.filter(data, request.term);
                        response(results.slice(0, 5));
                    });
                },
                minLength: 0,
                select: function (event, ui) {
                    addPosition(ui.item.value, 1);
                    $('#newArticle').val('');
                    return false;
                }
            }).focus(function () {
                $(this).autocomplete("search", "");
            });
        });
    </script>
</body>

</html>
